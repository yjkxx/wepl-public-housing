events {}

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    # Cache for detail pages
    proxy_cache_path /var/cache/nginx/proxy_cache levels=1:2 keys_zone=s3_cache:10m max_size=1g inactive=60m use_temp_path=off;

    server {
        listen 80;
        
        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Serve mainpage files (synced locally every 10 minutes)
        location / {
            root /usr/share/nginx/html/mainpage;
            index index.html;
            try_files $uri $uri/ @mainpage_fallback;
            
            # Cache control for mainpage files
            expires 10m;
            add_header Cache-Control "public, must-revalidate";
        }
        
        # Fallback for mainpage - try root directory
        location @mainpage_fallback {
            root /usr/share/nginx/html;
            try_files $uri $uri/ =404;
        }

        # Detail pages - fetch from S3 on demand and cache locally
        location /detail/ {
            # Try to serve from proxy cache first, then fetch from S3
            proxy_cache s3_cache;
            proxy_cache_valid 200 1h;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_lock on;
            
            # S3 configuration
            proxy_pass https://wepl-posting-pages.s3.ap-northeast-2.amazonaws.com$uri;
            proxy_set_header Host wepl-posting-pages.s3.ap-northeast-2.amazonaws.com;
            proxy_set_header User-Agent "nginx-wepl-cache/1.0";
            
            # Handle S3 response
            proxy_intercept_errors on;
            error_page 404 = @detail_not_found;
            
            # Cache control for detail pages
            expires 1h;
            add_header Cache-Control "public";
            add_header X-Cache-Status $upstream_cache_status always;
        }
        
        # Handle detail page not found
        location @detail_not_found {
            return 404 "Detail page not found";
            add_header Content-Type text/plain;
        }

        # Legacy endpoint (keep for backward compatibility)
        location /legacy/ {
            proxy_pass https://wepl-posting-pages.s3-website.ap-northeast-2.amazonaws.com/;
            proxy_set_header Host $host;
            
            # Cache legacy responses briefly
            proxy_cache s3_cache;
            proxy_cache_valid 200 5m;
            add_header X-Cache "LEGACY";
        }
        
        # Cache status endpoint for monitoring
        location /cache-status {
            access_log off;
            return 200 "Cache directory: /var/cache/nginx/\nProxy cache: /var/cache/nginx/proxy_cache/\nMainpage sync: /usr/share/nginx/html/mainpage/\n";
            add_header Content-Type text/plain;
        }
    }
}
